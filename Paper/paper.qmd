---
title: "Analysis"
author: "Austin Martinez"
format: html
editor: visual
---

# Background

```{r}
#loading in libraries
library(dplyr)
library(tidyverse)
library(slider)
```

# Data

```{r}
# Reading in CSVs
# I cleaned the Data on a seperate R script called clean_code.qmd in Scripts/Supporting Code
q1_unique <-read_csv(here::here("Data", "cleaned_data", "q1_unique.csv"))
q2_unique <- read_csv(here::here("Data", "cleaned_data", "q2_unique.csv"))
q3_unique <- read_csv(here::here("Data", "cleaned_data", "q3_unique.csv"))
prm_unique <- read_csv(here::here("Data", "cleaned_data", "prm_unique.csv"))


```

# Methods

```{r}
# Calculation centered moving average for NH4_N, Ca, Mg, NO3_N, and K for each data with a 9 week sliding window.
# Calculation moving average for Q1
q1collumns <- c("nh4_n", "ca", "mg", "no3_n", "k")
for (col in q1collumns) {
  q1_unique <- q1_unique %>% # Won't work with |> pipes. 
    mutate(
      !!paste0(col, "_rolling_avg") := slide_index_dbl(
        .x = .[[col]],
        .i = sample_date,
        .f = ~mean(.x, na.rm = TRUE),
        .before = (7*9)/2,   
        .after  = (7*9)/2,
        .complete = FALSE
      )
    )
}

# Calculation moving average for Q2
q2collumns <- c("nh4_n", "ca", "mg", "no3_n", "k")
for (col in q2collumns) {
  q2_unique <- q2_unique %>%
    mutate(
      !!paste0(col, "_rolling_avg") := slide_index_dbl(
        .x = .[[col]],
        .i = sample_date,
        .f = ~mean(.x, na.rm = TRUE),  
        .before = (7*9)/2,
        .after  = (7*9)/2,
        .complete = FALSE
      )
    )
}

# Calculation moving average for Q3
q3collumns <- c("nh4_n", "ca", "mg", "no3_n", "k")
for (col in q3collumns) {
  q3_unique <- q3_unique %>%
    mutate(
      !!paste0(col, "_rolling_avg") := slide_index_dbl(
        .x = .[[col]],
        .i = sample_date,
        .f = ~mean(.x, na.rm = TRUE),  
        .before = (7*9)/2, 
        .after  = (7*9)/2,
        .complete = FALSE
      )
    )
}

# Calculation moving average for Q3
prmcollumns <- c("nh4_n", "ca", "mg", "no3_n", "k")
for (col in prmcollumns) {
  prm_unique <- prm_unique %>%
    mutate(
      !!paste0(col, "_rolling_avg") := slide_index_dbl(
        .x = .[[col]],
        .i = sample_date,
        .f = ~mean(.x, na.rm = TRUE),
        .before = (7*9)/2,
        .after  = (7*9)/2,
        .complete = FALSE
      )
    )
}

# Combing all data sets(q1_unique, q2_unique, q3_unique, prm_unique) into one.
river_df <- bind_rows(q1_unique, q2_unique, q3_unique, prm_unique)

# Pivoting longer so I can facet wrap my ggplot for contaminants
river_long <- pivot_longer(data = river_df, 
                           cols =  c("nh4_n_rolling_avg", "ca_rolling_avg", 
                                     "mg_rolling_avg", "no3_n_rolling_avg", "k_rolling_avg"), 
                           names_to = "contaminant",
                           values_to = "rolling_avgs")
```

# Results

```{r}
# Generates ggplot 
# I'm still unsure if I use the bottom or top one.
# I still need to add that line that shows when the hurricane is at.

# Keeps the NAs in rolling_avgs
ggplot(data = river_long, aes(x = sample_date, y = rolling_avgs, linetype = sample_id)) +
  geom_line() + facet_wrap(~contaminant, scales = "free_y", ncol = 1) +
  theme_linedraw()+ labs(x = "Year", y = "Rolling Means")

# Removes the NAs in rolling_avgs
ggplot(data = river_long %>% 
         filter(!is.na(rolling_avgs)),
  aes(x = sample_date, y = rolling_avgs, linetype = sample_id)) +
  geom_line() + facet_wrap(~contaminant, scales = "free_y", ncol = 1) +
  theme_linedraw()+ labs(x = "Year", y = "Rolling Means")
```
